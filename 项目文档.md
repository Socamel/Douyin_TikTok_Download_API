# 抖音/TikTok下载API - 项目文档

## 📋 项目概述

本项目是一个功能完整的抖音/TikTok视频下载API，支持无水印视频解析、Cookie管理、Aitable.ai集成、视频去重等高级功能�?

### 🎯 主要功能

1. **视频解析下载** - 支持抖音、TikTok、B站等平台
2. **Cookie管理** - 自动验证、存储、过期提�?
3. **Aitable.ai集成** - 自动化数据同�?
4. **视频去重** - 智能去重，避免重复下�?
5. **Web界面** - 友好的用户界�?
6. **API接口** - 完整的RESTful API

### 🏗�?技术架�?

- **后端框架**: FastAPI + PyWebIO
- **数据�?*: SQLite
- **爬虫引擎**: 自研多平台爬�?
- **集成服务**: Aitable.ai API
- **部署**: Docker + Linux VPS

## 🚀 快速开�?

### 环境要求

- Python 3.8+
- SQLite 3
- 网络连接

### 安装步骤

1. **克隆项目**
```bash
git clone https://github.com/your-repo/Douyin_TikTok_Download_API.git
cd Douyin_TikTok_Download_API
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **初始化数据库**
```bash
python init_database.py
```

4. **启动服务**
```bash
python start_with_cookie.py
```

### 访问地址

- **Web界面**: http://localhost:8501
- **API文档**: http://localhost:8501/docs
- **健康检查**: http://localhost:8501/health

## 📚 功能模块

### 1. 视频解析模块

#### 支持的平�?
- **抖音**: 用户视频、单个视频、直�?
- **TikTok**: 国际版视频解�?
- **B�?*: 视频解析下载

#### 主要API端点
```
GET /api/douyin/web/fetch_user_post_videos - 获取用户视频
GET /api/douyin/web/fetch_one_video - 获取单个视频
GET /api/douyin/fetch_user_new_videos - 获取新视频（去重�?
GET /api/tiktok/web/parse - TikTok视频解析
GET /api/bilibili/web/parse - B站视频解�?
```

### 2. Cookie管理模块

#### 功能特�?
- **自动验证**: 检查Cookie有效�?
- **过期提醒**: 网页弹窗提醒
- **多平台支�?*: 抖音、TikTok�?
- **历史记录**: 保存Cookie更新历史

#### API端点
```
GET /api/cookie/status - 获取Cookie状�?
POST /api/cookie/update_cookie - 更新Cookie
GET /api/cookie/test - 测试Cookie
DELETE /api/cookie/clear - 清除Cookie
GET /api/cookie/history - Cookie历史
```

### 3. Aitable.ai集成模块

#### 集成特�?
- **自动化同�?*: 实时数据同步
- **状态管�?*: Refresh Cookie、Add user_id、Delete user_id
- **批量处理**: 支持批量操作
- **错误处理**: 完善的错误处理机�?

#### 主要API端点
```
POST /api/aitable/blogger_cookie - Blogger Cookie同步
GET /api/aitable/get_users - 获取所有博�?
GET /api/aitable/get_cookies - 获取所有Cookie
PUT /api/aitable/update_user - 更新Blogger信息
POST /api/aitable/sync_status - 获取同步状�?
```

#### 数据格式示例
```json
{
  "recordId": "recvT3eLiaaE4",
  "fields": {
    "Blogger": "板哥实战之路",
    "Status": "Refresh Cookie",
    "user_id": "MS4wLjABAAAAzdUNicnvSbYj3AfLtAhThVtATHyveJSaAE9hm0ul1_w",
    "cookie": "hevc_supported=true; s_v_web_id=verify_mecdiydz_Rpzrmy9K_gwM3_4ryS_8uu0_AJo9SrtOUJid; ..."
  }
}
```

### 4. 视频去重模块

#### 去重逻辑
- **数据库存�?*: 所有视频信息存储在SQLite
- **智能对比**: 基于video_id进行去重
- **新视频识�?*: 只返回数据库中不存在的新视频
- **用户管理**: 自动保存用户信息

#### 使用示例
```bash
curl -X GET "http://localhost:80/api/douyin/fetch_user_new_videos?sec_user_id=MS4wLjABAAAAzdUNicnvSbYj3AfLtAhThVtATHyveJSaAE9hm0ul1_w"
```

## 🗄�?数据库设�?

### 表结�?

#### 1. users�?- 用户信息
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT UNIQUE NOT NULL,
    username TEXT,
    nickname TEXT,
    avatar_url TEXT,
    follower_count INTEGER DEFAULT 0,
    following_count INTEGER DEFAULT 0,
    video_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. cookies�?- Cookie管理
```sql
CREATE TABLE cookies (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    cookie_data TEXT NOT NULL,
    platform TEXT DEFAULT 'douyin',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT 1,
    expires_at TIMESTAMP
);
```

#### 3. videos�?- 视频信息
```sql
CREATE TABLE videos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    video_id TEXT UNIQUE NOT NULL,
    user_id TEXT NOT NULL,
    title TEXT,
    description TEXT,
    video_url TEXT,
    cover_url TEXT,
    duration INTEGER,
    play_count INTEGER DEFAULT 0,
    like_count INTEGER DEFAULT 0,
    comment_count INTEGER DEFAULT 0,
    share_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);
```

## 🔧 配置说明

### 配置文件 (config.yaml)

```yaml
# 服务器配�?
Server:
  host: "127.0.0.1"
  port: 80
  debug: false

# 数据库配�?
Database:
  path: "douyin_data.db"
  backup_enabled: true
  backup_interval: 24

# Cookie配置
Cookie:
  validation_enabled: true
  auto_refresh: true
  expiration_warning_days: 7

# Aitable.ai配置
Aitable:
  api_token: "your_api_token"
  datasheet_id: "your_datasheet_id"
  view_id: "your_view_id"

# 爬虫配置
Crawler:
  timeout: 30
  retry_times: 3
  user_agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
```

## 🚀 部署指南

### 本地开发环�?

1. **Windows环境**
```bash
# 启动开发服务器
python start_with_cookie.py --reload

# 检查Cookie状�?
python start_with_cookie.py --check-cookie

# 初始化数据库
python start_with_cookie.py --init-db
```

2. **Linux/Mac环境**
```bash
# 给脚本执行权�?
chmod +x start.sh

# 启动服务
./start.sh
```

### 生产环境部署

#### Docker部署
```bash
# 构建镜像
docker build -t douyin-api .

# 运行容器
docker run -d -p 8501:8501 --name douyin-api douyin-api

# 使用docker-compose
docker-compose up -d
```

#### VPS部署
```bash
# 安装依赖
sudo apt update
sudo apt install python3 python3-pip sqlite3

# 配置服务
sudo cp douyin-api.service /etc/systemd/system/
sudo systemctl enable douyin-api
sudo systemctl start douyin-api
```

## 📊 API文档

### 认证方式
目前API采用无认证方式，建议在生产环境中添加API密钥认证�?

### 响应格式
所有API响应都采用统一格式�?

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    // 具体数据
  }
}
```

### 错误处理
```json
{
  "code": 400,
  "message": "请求参数错误",
  "detail": "具体错误信息"
}
```

## 🧪 测试指南

### 功能测试

1. **Cookie管理测试**
```bash
# 测试Cookie状�?
curl -X GET http://localhost:8501/api/cookie/status

# 测试Cookie更新
curl -X POST http://localhost:8501/api/cookie/update_cookie \
  -H "Content-Type: application/json" \
  -d '{"cookie_data": "your_cookie_here"}'
```

2. **Aitable.ai集成测试**
```bash
# 测试新增Blogger
curl -X POST http://localhost:8501/api/aitable/blogger_cookie \
  -H "Content-Type: application/json" \
  -d '{
    "recordId": "test_001",
    "fields": {
      "Blogger": "测试Blogger",
      "Status": "Add user_id",
      "user_id": "MS4wLjABAAAAtest_user_id"
    }
  }'
```

3. **视频去重测试**
```bash
# 测试获取新视�?
curl -X GET "http://localhost:80/api/douyin/fetch_user_new_videos?sec_user_id=MS4wLjABAAAAzdUNicnvSbYj3AfLtAhThVtATHyveJSaAE9hm0ul1_w"
```

### 自动化测�?

项目提供了完整的测试脚本�?

- `test_aitable_api.ps1` - Windows PowerShell测试脚本
- `test_aitable_api.sh` - Linux/Mac Bash测试脚本
- `config.yaml` - 配置文件（包含Aitable.ai配置）

## 🔍 监控和日�?

### 日志配置
```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/app.log'),
        logging.StreamHandler()
    ]
)
```

### 健康检�?
```bash
# 检查服务状�?
curl -X GET http://localhost:8501/health

# 检查数据库状�?
curl -X POST http://localhost:8501/api/aitable/sync_status
```

### 性能监控
- API响应时间监控
- 数据库连接状�?
- Cookie有效性检�?
- 视频去重统计

## 🔐 安全考虑

### 当前安全措施
1. **输入验证**: 所有API输入都经过验�?
2. **SQL注入防护**: 使用参数化查�?
3. **错误信息**: 不暴露敏感信�?
4. **日志记录**: 记录所有操作日�?

### 建议改进
1. **HTTPS**: 生产环境使用HTTPS
2. **API认证**: 添加API密钥认证
3. **IP白名�?*: 限制访问IP
4. **数据加密**: 敏感数据加密存储

## 🐛 故障排除

### 常见问题

#### 1. Cookie验证失败
**问题**: Cookie验证失败，无法获取视�?
**解决**: 
- 检查Cookie是否完整
- 确认Cookie未过�?
- 重新获取Cookie

#### 2. 数据库连接错�?
**问题**: 数据库连接失�?
**解决**:
```bash
# 重新初始化数据库
python init_database.py --reset

# 检查数据库文件权限
chmod 644 douyin_data.db
```

#### 3. Aitable.ai同步失败
**问题**: 数据同步失败
**解决**:
- 检查API Token是否正确
- 确认网络连接正常
- 查看错误日志

#### 4. 视频去重不工�?
**问题**: 视频去重功能异常
**解决**:
- 检查数据库表结�?
- 确认video_id字段正确
- 重新初始化数据库

### 日志分析
```bash
# 查看应用日志
tail -f logs/app.log

# 查看错误日志
grep "ERROR" logs/app.log

# 查看API访问日志
grep "POST\|GET" logs/app.log
```

## 📈 性能优化

### 数据库优�?
1. **索引优化**: 为常用查询字段添加索�?
2. **连接�?*: 使用数据库连接池
3. **查询优化**: 优化复杂查询语句

### 缓存策略
1. **Redis缓存**: 缓存热门视频信息
2. **内存缓存**: 缓存用户信息
3. **CDN加�?*: 静态资源CDN加�?

### 并发处理
1. **异步处理**: 使用异步IO处理请求
2. **任务队列**: 使用Celery处理耗时任务
3. **负载均衡**: 多实例负载均�?

## 🔄 更新日志

### v2.0.0 (2024-01-15)
- �?新增Aitable.ai集成功能
- �?新增视频去重功能
- �?新增Cookie管理模块
- �?新增Web界面
- 🐛 修复多个已知问题
- 📚 完善文档和测�?

### v1.5.0 (2024-01-10)
- �?新增B站视频解�?
- �?优化TikTok解析
- 🐛 修复Cookie过期问题

### v1.0.0 (2024-01-01)
- 🎉 初始版本发布
- �?支持抖音视频解析
- �?支持TikTok视频解析

## 🤝 贡献指南

### 开发环境设�?
1. Fork项目
2. 创建功能分支
3. 提交代码
4. 创建Pull Request

### 代码规范
- 使用Python PEP 8规范
- 添加类型注解
- 编写单元测试
- 更新文档

### 提交规范
```
feat: 新功�?
fix: 修复bug
docs: 文档更新
style: 代码格式
refactor: 重构
test: 测试
chore: 构建过程或辅助工具的变动
```

## 📞 技术支�?

### 联系方式
- **GitHub Issues**: [项目Issues页面]
- **邮箱**: your-email@example.com
- **QQ�?*: 123456789

### 支持时间
- 工作�? 9:00-18:00
- 周末: 10:00-16:00

### 常见问题FAQ
1. **Q: 如何获取Cookie�?*
   A: 参考Cookie获取教程文档

2. **Q: 支持哪些平台�?*
   A: 目前支持抖音、TikTok、B�?

3. **Q: 如何配置Aitable.ai�?*
   A: 参考Aitable.ai集成指南

## 📄 许可�?

本项目采�?MIT 许可证，详见 [LICENSE](LICENSE) 文件�?

## 🙏 致谢

感谢以下开源项目的支持�?
- FastAPI - 现代、快速的Web框架
- PyWebIO - 简单的Web应用框架
- SQLite - 轻量级数据库
- Aitable.ai - 数据管理平台

---

**注意**: 本项目仅供学习和研究使用，请遵守相关法律法规和平台使用条款�?

