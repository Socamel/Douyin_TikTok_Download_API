# 增强版定时任务系统使用说明

## 概述

这个系统可以定时抓取关注博主的新视频，并将每个视频分别存储到 Aitable.ai 中。

## 快速开始

### 1. 配置 Aitable.ai

编辑 `config.yaml` 文件，设置 Aitable.ai 配置：
```yaml
Aitable:
  api_key: "uskIZVNT6ybBEQxO5cTPcCa"    # 你的Aitable.ai API Key
  base_id: "dstGGELxSrPMb0kRWa"         # 你的Aitable.ai Datasheet ID
  table_name: "viwMgMZrxb1Zv"           # View ID
```

### 2. 启动 API 服务器

```bash
python start.py
```

### 3. 获取 Datasheet ID

获取 Datasheet ID：
- 打开你的 Aitable.ai 数据表
- 查看URL: `https://aitable.ai/datasheet/DATASHEET_ID`
- DATASHEET_ID 就是你的 Datasheet ID

#### 添加关注博主

##### 方法一：通过 Aitable.ai Webhook (推荐)
1. 在 Aitable.ai 中设置 webhook URL: `http://your-server:8501/api/aitable/blogger_cookie`
2. 在 Aitable.ai 中添加博主记录，设置 `Status` 为 `Add user_id`

##### 方法二：直接调用 API
```bash
curl -X POST "http://localhost:8501/api/aitable/add_user" \
     -H "Content-Type: application/json" \
     -d '{
       "user_id": "MS4wLjABAAAAzdUNicnvSbYj3AfLtAhThVtATHyveJSaAE9hm0ul1_w",
       "username": "博主用户名",
       "nickname": "博主昵称"
     }'
```

### 4. 启动定时任务

```bash
python enhanced_scheduler.py
```

## 系统特点

- ✅ **定时执行**: 每天 12:00、17:00、20:00、22:00 自动执行
- ✅ **多视频处理**: 每个新视频在 Aitable.ai 中创建独立行
- ✅ **自动去重**: 只获取新视频，避免重复
- ✅ **并发处理**: 同时处理多个博主
- ✅ **完整日志**: 详细记录执行过程

## 数据流程

```
定时任务 → 调用API → 获取新视频 → 解析数据 → 存储到Aitable.ai
```

## 数据格式

系统会将每个新视频存储为 Aitable.ai 中的一条记录，包含以下字段：

- **Title**: 视频标题
- **URL**: 视频链接
- **Blogger**: 博主昵称

## 新增简化格式API

项目新增了专门用于 Aitable.ai 存储的简化格式API：

### 简化格式API列表
- `GET /api/douyin/simple/fetch_user_new_videos_simple` - 获取用户新视频（简化格式）
- `GET /api/douyin/simple/fetch_user_post_videos_simple` - 获取用户发布视频（简化格式）
- `GET /api/douyin/simple/fetch_user_like_videos_simple` - 获取用户喜欢视频（简化格式）
- `GET /api/douyin/simple/fetch_user_collection_videos_simple` - 获取用户收藏视频（简化格式）
- `GET /api/douyin/simple/fetch_user_mix_videos_simple` - 获取用户合辑视频（简化格式）

### 简化格式API特点
- 所有API都输出统一的 `Title`、`URL`、`Blogger` 三个字段
- 每个视频在 Aitable.ai 中创建独立的一行记录
- 专门为 Aitable.ai 存储优化
- 与原有详细格式API并存，不影响现有功能

## 管理命令

### 查看博主列表
```bash
curl -X GET "http://localhost:8501/api/aitable/get_users"
```

### 删除博主
```bash
curl -X DELETE "http://localhost:8501/api/aitable/delete_user/user_id"
```

### 测试 Aitable.ai 连接
```bash
curl -X GET "http://localhost:80/api/aitable/test_connection"
```

## 日志查看

```bash
# 查看实时日志
tail -f enhanced_scheduler.log

# 查看最近日志
tail -n 100 enhanced_scheduler.log
```

## 注意事项

1. 确保 API 服务器正在运行
2. 确保 Aitable.ai 配置正确（API Key 和 Datasheet ID）
3. 确保网络连接正常
4. 检查日志文件了解执行状态

## 故障排除

如果遇到问题：
1. 运行 `curl -X GET "http://localhost:8501/api/aitable/test_connection"` 测试连接
2. 查看 `enhanced_scheduler.log` 日志
3. 检查 `config.yaml` 配置
4. 确认 Aitable.ai 表结构正确
