# 部署指南

## 📋 概述

本文档详细介绍了如何在不同环境中部署抖音/TikTok下载API项目，包括本地开发环境、生产环境、Docker部署等�?

## 🛠�?环境要求

### 系统要求
- **操作系统**: Windows 10+, macOS 10.14+, Ubuntu 18.04+
- **Python版本**: 3.8+
- **内存**: 最�?GB，推�?GB+
- **存储**: 最�?GB可用空间
- **网络**: 稳定的互联网连接

### 软件依赖
- Python 3.8+
- pip (Python包管理器)
- SQLite 3
- Git (可选，用于版本控制)

## 🚀 本地开发环境部�?

### Windows环境

#### 1. 安装Python
```bash
# 下载并安装Python 3.8+
# 访问 https://www.python.org/downloads/
# 确保勾�?Add Python to PATH"
```

#### 2. 克隆项目
```bash
# 使用Git克隆
git clone https://github.com/your-repo/Douyin_TikTok_Download_API.git
cd Douyin_TikTok_Download_API

# 或直接下载ZIP文件并解�?
```

#### 3. 创建虚拟环境
```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环�?
venv\Scripts\activate
```

#### 4. 安装依赖
```bash
# 升级pip
python -m pip install --upgrade pip

# 安装项目依赖
pip install -r requirements.txt
```

#### 5. 初始化数据库
```bash
# 初始化数据库
python init_database.py

# 查看数据库信�?
python init_database.py --info
```

#### 6. 启动服务
```bash
# 启动开发服务器
python start_with_cookie.py

# 或使用开发模式（自动重载�?
python start_with_cookie.py --reload

# 指定端口启动
python start_with_cookie.py --port 80
```

### macOS/Linux环境

#### 1. 安装Python
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3 python3-pip python3-venv

# macOS (使用Homebrew)
brew install python3

# CentOS/RHEL
sudo yum install python3 python3-pip
```

#### 2. 克隆项目
```bash
git clone https://github.com/your-repo/Douyin_TikTok_Download_API.git
cd Douyin_TikTok_Download_API
```

#### 3. 创建虚拟环境
```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环�?
source venv/bin/activate
```

#### 4. 安装依赖
```bash
# 升级pip
python -m pip install --upgrade pip

# 安装项目依赖
pip install -r requirements.txt
```

#### 5. 初始化数据库
```bash
# 初始化数据库
python init_database.py

# 查看数据库信�?
python init_database.py --info
```

#### 6. 启动服务
```bash
# 启动开发服务器
python start_with_cookie.py

# 或使用开发模�?
python start_with_cookie.py --reload

# 后台运行
nohup python start_with_cookie.py > app.log 2>&1 &
```

## 🐳 Docker部署

### 1. 安装Docker

#### Windows/macOS
```bash
# 下载并安装Docker Desktop
# 访问 https://www.docker.com/products/docker-desktop
```

#### Linux
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install docker.io docker-compose
sudo systemctl start docker
sudo systemctl enable docker

# 添加用户到docker�?
sudo usermod -aG docker $USER
```

### 2. 构建镜像
```bash
# 构建Docker镜像
docker build -t douyin-api .

# 查看镜像
docker images
```

### 3. 运行容器
```bash
# 运行容器
docker run -d -p 80:80 --name douyin-api douyin-api

# 查看容器状�?
docker ps

# 查看容器日志
docker logs douyin-api
```

### 4. 使用docker-compose
```bash
# 启动服务
docker-compose up -d

# 查看服务状�?
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

### 5. 数据持久�?
```bash
# 创建数据�?
docker volume create douyin-data

# 运行容器并挂载数据卷
docker run -d -p 80:80 \
  -v douyin-data:/app/data \
  --name douyin-api douyin-api
```

## ☁️ 云服务器部署

### VPS部署 (Ubuntu 20.04)

#### 1. 服务器准�?
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要软件
sudo apt install -y python3 python3-pip python3-venv sqlite3 nginx supervisor

# 安装Git
sudo apt install -y git
```

#### 2. 创建应用用户
```bash
# 创建应用用户
sudo useradd -m -s /bin/bash douyin
sudo passwd douyin

# 切换到应用用�?
sudo su - douyin
```

#### 3. 部署应用
```bash
# 克隆项目
git clone https://github.com/your-repo/Douyin_TikTok_Download_API.git
cd Douyin_TikTok_Download_API

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 初始化数据库
python init_database.py
```

#### 4. 配置Supervisor
```bash
# 创建Supervisor配置
sudo nano /etc/supervisor/conf.d/douyin-api.conf
```

配置文件内容�?
```ini
[program:douyin-api]
command=/home/douyin/Douyin_TikTok_Download_API/venv/bin/python /home/douyin/Douyin_TikTok_Download_API/start_with_cookie.py
directory=/home/douyin/Douyin_TikTok_Download_API
user=douyin
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/douyin-api.log
environment=PYTHONPATH="/home/douyin/Douyin_TikTok_Download_API"
```

```bash
# 重新加载Supervisor配置
sudo supervisorctl reread
sudo supervisorctl update

# 启动服务
sudo supervisorctl start douyin-api

# 查看状�?
sudo supervisorctl status douyin-api
```

#### 5. 配置Nginx
```bash
# 创建Nginx配置
sudo nano /etc/nginx/sites-available/douyin-api
```

配置文件内容�?
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /static {
        alias /home/douyin/Douyin_TikTok_Download_API/static;
    }
}
```

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/douyin-api /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

#### 6. 配置防火�?
```bash
# 允许HTTP和HTTPS
sudo ufw allow 80
sudo ufw allow 443
sudo ufw allow 22

# 启用防火�?
sudo ufw enable
```

### 使用systemd服务

#### 1. 创建服务文件
```bash
sudo nano /etc/systemd/system/douyin-api.service
```

服务文件内容�?
```ini
[Unit]
Description=Douyin API Service
After=network.target

[Service]
Type=simple
User=douyin
WorkingDirectory=/home/douyin/Douyin_TikTok_Download_API
Environment=PATH=/home/douyin/Douyin_TikTok_Download_API/venv/bin
ExecStart=/home/douyin/Douyin_TikTok_Download_API/venv/bin/python start_with_cookie.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 2. 启动服务
```bash
# 重新加载systemd
sudo systemctl daemon-reload

# 启用服务
sudo systemctl enable douyin-api

# 启动服务
sudo systemctl start douyin-api

# 查看状�?
sudo systemctl status douyin-api

# 查看日志
sudo journalctl -u douyin-api -f
```

## 🔧 配置管理

### 环境变量配置

创建 `.env` 文件�?
```bash
# 数据库配�?
DATABASE_PATH=douyin_data.db
DATABASE_BACKUP_ENABLED=true
DATABASE_BACKUP_INTERVAL=24

# 服务器配�?
HOST=0.0.0.0
PORT=80
DEBUG=false

# Cookie配置
COOKIE_VALIDATION_ENABLED=true
COOKIE_AUTO_REFRESH=true
COOKIE_EXPIRATION_WARNING_DAYS=7

# Aitable.ai配置
AITABLE_API_TOKEN=your_api_token
AITABLE_DATASHEET_ID=your_datasheet_id
AITABLE_VIEW_ID=your_view_id

# 爬虫配置
CRAWLER_TIMEOUT=30
CRAWLER_RETRY_TIMES=3
CRAWLER_USER_AGENT=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
```

### 配置文件 (config.yaml)

```yaml
# 服务器配�?
Server:
  host: "0.0.0.0"
  port: 80
  debug: false
  workers: 4

# 数据库配�?
Database:
  path: "douyin_data.db"
  backup_enabled: true
  backup_interval: 24
  max_connections: 10

# Cookie配置
Cookie:
  validation_enabled: true
  auto_refresh: true
  expiration_warning_days: 7
  max_history: 10

# Aitable.ai配置
Aitable:
  api_token: "your_api_token"
  datasheet_id: "your_datasheet_id"
  view_id: "your_view_id"
  sync_interval: 300

# 爬虫配置
Crawler:
  timeout: 30
  retry_times: 3
  user_agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
  max_concurrent: 5

# 日志配置
Logging:
  level: "INFO"
  file: "logs/app.log"
  max_size: "10MB"
  backup_count: 5

# 安全配置
Security:
  cors_origins: ["*"]
  rate_limit: 100
  rate_limit_window: 60
```

## 📊 监控和维�?

### 日志管理

#### 1. 日志配置
```python
import logging
from logging.handlers import RotatingFileHandler

# 配置日志
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        RotatingFileHandler('logs/app.log', maxBytes=10*1024*1024, backupCount=5),
        logging.StreamHandler()
    ]
)
```

#### 2. 日志轮转
```bash
# 创建日志目录
mkdir -p logs

# 设置日志权限
chmod 755 logs
chown douyin:douyin logs
```

### 性能监控

#### 1. 系统监控
```bash
# 监控CPU和内存使�?
htop

# 监控磁盘使用
df -h

# 监控网络连接
netstat -tulpn
```

#### 2. 应用监控
```bash
# 查看应用进程
ps aux | grep python

# 查看端口占用
lsof -i :80

# 查看应用日志
tail -f logs/app.log
```

### 数据库维�?

#### 1. 数据库备�?
```bash
# 创建备份脚本
nano backup_database.sh
```

备份脚本内容�?
```bash
#!/bin/bash
BACKUP_DIR="/home/douyin/backups"
DATE=$(date +%Y%m%d_%H%M%S)
DB_FILE="douyin_data.db"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据�?
cp $DB_FILE $BACKUP_DIR/${DB_FILE}_${DATE}.backup

# 压缩备份文件
gzip $BACKUP_DIR/${DB_FILE}_${DATE}.backup

# 删除7天前的备�?
find $BACKUP_DIR -name "*.backup.gz" -mtime +7 -delete

echo "Database backup completed: ${DB_FILE}_${DATE}.backup.gz"
```

```bash
# 设置执行权限
chmod +x backup_database.sh

# 添加到crontab
crontab -e
# 添加以下行（每天凌晨2点备份）
0 2 * * * /home/douyin/backup_database.sh
```

#### 2. 数据库优�?
```bash
# 进入SQLite命令�?
sqlite3 douyin_data.db

# 优化数据�?
VACUUM;
ANALYZE;

# 查看数据库大�?
SELECT page_count * page_size as size FROM pragma_page_count(), pragma_page_size();
```

## 🔒 安全配置

### 1. HTTPS配置

#### 使用Let's Encrypt
```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加以下�?
0 12 * * * /usr/bin/certbot renew --quiet
```

#### 更新Nginx配置
```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;

    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    location / {
        proxy_pass http://127.0.0.1:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

### 2. 防火墙配�?
```bash
# 配置UFW防火�?
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
```

### 3. API认证
```python
# 添加API密钥认证
from fastapi import HTTPException, Depends
from fastapi.security import HTTPBearer

security = HTTPBearer()

async def verify_api_key(credentials = Depends(security)):
    if credentials.credentials != "your-api-key":
        raise HTTPException(status_code=401, detail="Invalid API key")
    return credentials.credentials
```

## 🚨 故障排除

### 常见问题

#### 1. 端口被占�?
```bash
# 查看端口占用
lsof -i :80

# 杀死占用进�?
kill -9 <PID>

# 或使用不同端�?
python start_with_cookie.py --port 80
```

#### 2. 权限问题
```bash
# 修复文件权限
chmod 755 start_with_cookie.py
chmod 644 config.yaml
chmod 755 logs/
chown -R douyin:douyin /home/douyin/Douyin_TikTok_Download_API
```

#### 3. 数据库锁�?
```bash
# 删除数据库锁定文�?
rm -f douyin_data.db-journal

# 或重新初始化数据�?
python init_database.py --reset
```

#### 4. 内存不足
```bash
# 查看内存使用
free -h

# 增加swap空间
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### 日志分析
```bash
# 查看错误日志
grep "ERROR" logs/app.log

# 查看访问日志
grep "POST\|GET" logs/app.log

# 实时监控日志
tail -f logs/app.log | grep -E "(ERROR|WARNING)"
```

## 📈 性能优化

### 1. 应用优化
- 使用异步处理
- 实现缓存机制
- 优化数据库查�?
- 使用连接�?

### 2. 系统优化
- 调整内核参数
- 优化文件描述符限�?
- 配置内存管理
- 使用SSD存储

### 3. 网络优化
- 使用CDN加�?
- 配置负载均衡
- 优化网络配置
- 使用HTTP/2

## 🔄 更新部署

### 1. 代码更新
```bash
# 拉取最新代�?
git pull origin main

# 更新依赖
pip install -r requirements.txt

# 重启服务
sudo systemctl restart douyin-api
```

### 2. 数据库迁�?
```bash
# 备份当前数据�?
cp douyin_data.db douyin_data.db.backup

# 运行迁移脚本
python migrate_database.py

# 验证数据完整�?
python verify_database.py
```

### 3. 回滚操作
```bash
# 停止服务
sudo systemctl stop douyin-api

# 恢复数据�?
cp douyin_data.db.backup douyin_data.db

# 回滚代码
git reset --hard HEAD~1

# 重启服务
sudo systemctl start douyin-api
```

## 📞 技术支�?

### 联系方式
- **GitHub Issues**: [项目Issues页面]
- **邮箱**: your-email@example.com
- **QQ�?*: 123456789

### 支持时间
- 工作�? 9:00-18:00
- 周末: 10:00-16:00

### 常见问题FAQ
1. **Q: 如何查看服务状态？**
   A: 使用 `sudo systemctl status douyin-api` �?`sudo supervisorctl status douyin-api`

2. **Q: 如何查看应用日志�?*
   A: 使用 `tail -f logs/app.log` �?`sudo journalctl -u douyin-api -f`

3. **Q: 如何重启服务�?*
   A: 使用 `sudo systemctl restart douyin-api` �?`sudo supervisorctl restart douyin-api`

4. **Q: 如何备份数据库？**
   A: 使用 `cp douyin_data.db backup/` 或运行备份脚�?

---

**注意**: 部署前请确保已阅读并理解所有配置选项，建议在测试环境中先进行验证�?
